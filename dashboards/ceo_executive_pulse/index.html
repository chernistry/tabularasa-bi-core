<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CEO & Executive Pulse</title>
    <script src="https://cdn.plot.ly/plotly-2.31.1.min.js"></script>
    <link rel="stylesheet" href="../shared/main.css">
    <script src="../shared/plot-theme.js"></script>
</head>
<body>
    <header class="main-header">
        <a href="../../index.html" class="logo">TabulaRasa<span>.ai</span></a>
        <nav>
            <a href="./index.html" class="active">Executive Pulse</a>
            <a href="../advertiser_campaign_performance/index.html">Advertiser Performance</a>
            <a href="../bi_pipeline_health_data_trust/index.html">BI Pipeline Health</a>
        </nav>
    </header>

    <div class="dashboard-container">
        <h1 class="dashboard-title">Executive Pulse</h1>
        <p class="dashboard-subtitle">
            <strong>Narrative for C-Level:</strong> A high-level overview of the business's core vital signs, powered by the real-time data pipeline.
        </p>
        
        <div class="kpi-grid">
            <div class="card kpi-card">
                <div class="kpi-label">Total Impressions</div>
                <div id="kpi-impressions" class="kpi-value">Loading...</div>
            </div>
            <div class="card kpi-card">
                <div class="kpi-label">Total Clicks</div>
                <div id="kpi-clicks" class="kpi-value">Loading...</div>
            </div>
            <div class="card kpi-card">
                <div class="kpi-label">Click-Through Rate (CTR)</div>
                <div id="kpi-ctr" class="kpi-value">Loading...</div>
            </div>
            <div class="card kpi-card">
                <div class="kpi-label">Total Ad Spend</div>
                <div id="kpi-spend" class="kpi-value">Loading...</div>
            </div>
        </div>

        <div class="card" style="margin-top: 24px;">
            <div class="card-header">
                <h2 class="card-title">Advertiser ROI Trend</h2>
                 <span class="info-icon" onclick="showModal('roi-modal')">ℹ️</span>
            </div>
            <div id="roi-trend-chart" class="chart-container" style="min-height: 450px;"></div>
        </div>
    </div>
     <!-- Modals -->
    <div id="roi-modal" class="modal"><div class="modal-content"><span class="close-button" onclick="closeModal('roi-modal')">&times;</span><h3>Advertiser ROI Trend</h3><p>This chart shows the daily Return on Investment, calculated as `(Conversion Revenue / Impression Spend)`. It's a key measure of the platform's overall efficiency in generating value for advertisers.</p></div></div>


    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Fetch KPIs (handle 204/503 gracefully)
            fetch('/api/kpis')
                .then(async response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    if (response.status === 204) {
                        return null; // no data yet
                    }
                    return response.json();
                })
                .then(data => {
                    if (!data) {
                        ['impressions','clicks','ctr','spend'].forEach(id => document.getElementById(`kpi-${id}`).textContent = 'No data');
                        return;
                    }
                    document.getElementById('kpi-impressions').textContent = data.impressions.toLocaleString();
                    document.getElementById('kpi-clicks').textContent = data.clicks.toLocaleString();
                    document.getElementById('kpi-ctr').innerHTML = `${data.ctr.toFixed(2)}<span class="unit">%<\/span>`;
                    document.getElementById('kpi-spend').textContent = `$${(data.spend_usd / 1_000_000).toFixed(2)}M`;
                })
                .catch(error => {
                    console.error('Error fetching KPIs:', error);
                    ['impressions','clicks','ctr','spend'].forEach(id => document.getElementById(`kpi-${id}`).textContent = 'Error');
                });

            // Fetch ROI Trend
            fetch('/api/roi_trend')
                .then(async response => {
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    const dates = data.map(d => d.window_start_time);
                    const rois = data.map(d => d.roi);
                    const trendLayout = {
                        ...plotTheme,
                        title: { ...plotTheme.title, text: 'Daily Return on Investment (ROI)' },
                        xaxis: { title: 'Date' },
                        yaxis: { title: 'ROI' }
                    };
                    Plotly.newPlot('roi-trend-chart', [{
                        x: dates,
                        y: rois,
                        type: 'scatter',
                        mode: 'lines+markers',
                        fill: 'tozeroy',
                        line: { color: plotTheme.colorway[0], width: 2 },
                        marker: { size: 6 }
                    }], trendLayout, { responsive: true });
                })
                .catch(error => {
                    console.error('Error fetching ROI trend:', error);
                });
        });
    </script>
</body>
</html>
